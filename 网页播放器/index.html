<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniPlayer Pro - å£°é“ä¸å­—å¹•æ§åˆ¶ç‰ˆ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.bootcss.com/flv.js/1.5.0/flv.min.js"></script>
    
    <style>
        :root {
            --primary: #4facfe;
            --primary-grad: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-main: #333;
            --panel-bg: rgba(255, 255, 255, 0.95);
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --panel-bg: rgba(30, 30, 30, 0.95);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-main); display: flex; flex-direction: column; align-items: center; padding: 20px; min-height: 100vh; }
        
        /* é¡¶éƒ¨ä¸é€šç”¨ */
        header { width: 100%; max-width: 1000px; display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        h1 { font-size: 1.5rem; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn { padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; background: var(--card-bg); color: var(--text-main); cursor: pointer; display: inline-flex; align-items: center; gap: 5px; }
        .btn:hover { background: #eee; }
        [data-theme="dark"] .btn:hover { background: #333; border-color: #555; }

        /* æ’­æ”¾å™¨å®¹å™¨ */
        .player-wrapper {
            width: 100%; max-width: 1000px; position: relative; aspect-ratio: 16/9;
            background: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* æ§åˆ¶æ  */
        .controls-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            padding: 15px; display: flex; flex-direction: column; gap: 10px;
            opacity: 0; transition: opacity 0.3s;
        }
        .player-wrapper:hover .controls-overlay { opacity: 1; }

        /* è¿›åº¦æ¡ */
        .progress-container { width: 100%; height: 5px; background: rgba(255,255,255,0.3); cursor: pointer; border-radius: 5px; position: relative; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; border-radius: 5px; }

        /* æŒ‰é’®è¡Œ */
        .ctrl-row { display: flex; justify-content: space-between; align-items: center; color: white; }
        .ctrl-group { display: flex; gap: 15px; align-items: center; }
        .icon-btn { cursor: pointer; font-size: 1.1rem; color: #fff; background: none; border: none; }
        .icon-btn:hover { color: var(--primary); }

        /* ====== è®¾ç½®å¼¹çª— (å…³é”®æ–°å¢) ====== */
        .settings-panel {
            position: absolute; bottom: 60px; right: 15px;
            width: 260px; background: var(--panel-bg); color: var(--text-main);
            border-radius: 8px; padding: 15px; display: none;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 10;
            backdrop-filter: blur(10px);
        }
        .settings-panel.active { display: block; }
        
        .setting-item { margin-bottom: 15px; }
        .setting-label { font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; display: block; color: var(--primary); }
        .setting-select { width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #ccc; background: var(--bg-color); color: var(--text-main); }
        
        /* å£°é“æŒ‰é’®ç»„ */
        .channel-group { display: flex; gap: 5px; }
        .ch-btn { flex: 1; font-size: 0.8rem; padding: 5px; cursor: pointer; border: 1px solid #ccc; background: transparent; color: var(--text-main); border-radius: 4px; }
        .ch-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .input-area { width: 100%; max-width: 1000px; margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .drop-zone { border: 2px dashed #ccc; padding: 30px; text-align: center; border-radius: 8px; cursor: pointer; background: var(--card-bg); transition: 0.3s; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .drop-zone:hover { border-color: var(--primary); background: rgba(79, 172, 254, 0.1); }
        .url-zone { display: flex; gap: 10px; background: var(--card-bg); padding: 20px; border-radius: 8px; align-items: center; }
        .url-input { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #ddd; background: var(--bg-color); color: var(--text-main); }

        /* å†å²è®°å½•ç®€æ˜“ç‰ˆ */
        .history-panel { width: 100%; max-width: 1000px; margin-top: 20px; background: var(--card-bg); padding: 15px; border-radius: 8px; }
        .history-list { list-style: none; max-height: 100px; overflow-y: auto; margin-top: 10px; }
        .history-item { font-size: 0.9rem; padding: 5px 0; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .history-item:hover { color: var(--primary); }

        @media (max-width: 768px) { .input-area { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-film"></i> OmniPlayer Pro</h1>
        <button class="btn" onclick="toggleTheme()"><i class="fas fa-moon"></i> åˆ‡æ¢æ¨¡å¼</button>
    </header>

    <div class="player-wrapper" id="dropArea">
        <!-- crossOrigin å…è®¸ Web Audio API å¤„ç†è·¨åŸŸéŸ³é¢‘ -->
        <video id="video" playsinline crossorigin="anonymous"></video>
        
        <!-- å­—å¹•è½¨é“å ä½ -->
        <track id="extTrack" kind="subtitles" label="å¤–éƒ¨å­—å¹•" srclang="zh">

        <!-- æ§åˆ¶å±‚ -->
        <div class="controls-overlay">
            <div class="progress-container" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="ctrl-row">
                <div class="ctrl-group">
                    <button class="icon-btn" id="playBtn"><i class="fas fa-play"></i></button>
                    <span id="timeDisplay" style="font-size: 0.9rem;">00:00</span>
                    <i class="fas fa-volume-up icon-btn" id="muteBtn"></i>
                    <input type="range" id="volRange" min="0" max="1" step="0.1" value="1" style="width: 80px">
                </div>
                <div class="ctrl-group">
                    <button class="icon-btn" onclick="toggleSettings()" title="éŸ³è½¨/å­—å¹•/å£°é“è®¾ç½®">
                        <i class="fas fa-cog"></i> è®¾ç½®
                    </button>
                    <button class="icon-btn" onclick="toggleFullscreen()"><i class="fas fa-expand"></i></button>
                </div>
            </div>
        </div>

        <!-- æ‚¬æµ®è®¾ç½®é¢æ¿ -->
        <div class="settings-panel" id="settingsPanel">
            <!-- 1. å£°é“æ§åˆ¶ (é’ˆå¯¹å·¦å³å£°é“åˆ†ç¦»çš„è§†é¢‘) -->
            <div class="setting-item">
                <label class="setting-label">ğŸ”Š å£°é“æ¨¡å¼ (Web Audio)</label>
                <div class="channel-group">
                    <button class="ch-btn active" onclick="setChannel('stereo')">ç«‹ä½“å£°</button>
                    <button class="ch-btn" onclick="setChannel('left')">åªå¬å·¦</button>
                    <button class="ch-btn" onclick="setChannel('right')">åªå¬å³</button>
                </div>
                <div style="font-size:0.7rem; color:#888; margin-top:4px;">*ç”¨äºå·¦ä¼´å¥/å³äººå£°æˆ–åŒè¯­è§†é¢‘</div>
            </div>

            <!-- 2. éŸ³è½¨é€‰æ‹© (é’ˆå¯¹ M3U8 å¤šéŸ³è½¨) -->
            <div class="setting-item" id="audioTrackSection" style="display:none;">
                <label class="setting-label">ğŸµ åˆ‡æ¢éŸ³è½¨ (HLS)</label>
                <select id="audioTrackSelect" class="setting-select"></select>
            </div>

            <!-- 3. å­—å¹•é€‰æ‹© -->
            <div class="setting-item">
                <label class="setting-label">ğŸ’¬ å­—å¹•é€‰æ‹©</label>
                <select id="subTrackSelect" class="setting-select">
                    <option value="-1">å…³é—­å­—å¹•</option>
                </select>
                <button class="btn" style="width:100%; margin-top:5px; font-size:0.8rem;" onclick="document.getElementById('subFile').click()">
                    <i class="fas fa-upload"></i> åŠ è½½æœ¬åœ° .vtt/.srt
                </button>
            </div>

            <!-- 4. é€Ÿåº¦ & æ»¤é•œç®€æ˜“ç‰ˆ -->
            <div class="setting-item">
                <label class="setting-label">ğŸš€ æ’­æ”¾é€Ÿåº¦: <span id="speedVal">1.0x</span></label>
                <input type="range" min="0.5" max="2" step="0.25" value="1" style="width:100%" oninput="setSpeed(this.value)">
            </div>
        </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="input-area">
        <div class="drop-zone" id="dragBox">
            <i class="fas fa-file-video fa-2x" style="color:var(--primary); margin-bottom:10px;"></i>
            <p>æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°æ­¤å¤„</p>
            <p style="font-size:0.8rem; color:#888;">MP4, MKV, M3U8, WEBM</p>
        </div>
        <div class="url-zone">
            <input type="text" id="urlInput" class="url-input" placeholder="è¾“å…¥ M3U8 / MP4 é“¾æ¥...">
            <button class="btn" onclick="loadUrl()"><i class="fas fa-play"></i></button>
        </div>
    </div>

    <!-- å†å²è®°å½• -->
    <div class="history-panel">
        <h4 style="margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:5px;">æ’­æ”¾å†å²</h4>
        <ul class="history-list" id="historyList"></ul>
        <button class="btn" onclick="clearHistory()" style="font-size:0.8rem; margin-top:5px;">æ¸…ç©º</button>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥ -->
    <input type="file" id="videoFile" style="display:none" accept="video/*,.mkv,.flv">
    <input type="file" id="subFile" style="display:none" accept=".vtt,.srt">

    <script>
        // ================= æ ¸å¿ƒå˜é‡ =================
        const video = document.getElementById('video');
        const hls = new Hls();
        let audioCtx, sourceNode, splitterNode, mergerNode, leftGain, rightGain;
        let isAudioCtxInit = false;

        // ================= 1. Web Audio API å£°é“åˆ†ç¦»é€»è¾‘ =================
        function initAudioContext() {
            if (isAudioCtxInit) return;
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                sourceNode = audioCtx.createMediaElementSource(video);
                splitterNode = audioCtx.createChannelSplitter(2); // åˆ†ç¦»å·¦å³
                mergerNode = audioCtx.createChannelMerger(2);     // åˆå¹¶è¾“å‡º
                
                // åˆ›å»ºå¢ç›ŠèŠ‚ç‚¹æ§åˆ¶å·¦å³éŸ³é‡
                leftGain = audioCtx.createGain();
                rightGain = audioCtx.createGain();

                // è¿æ¥å›¾: Source -> Splitter -> (Gains) -> Merger -> Destination
                sourceNode.connect(splitterNode);

                // é»˜è®¤ç«‹ä½“å£°è¿æ¥
                splitterNode.connect(leftGain, 0); // å·¦ -> å·¦å¢ç›Š
                splitterNode.connect(rightGain, 1); // å³ -> å³å¢ç›Š
                
                leftGain.connect(mergerNode, 0, 0);  // å·¦å¢ç›Š -> è¾“å‡ºå·¦
                rightGain.connect(mergerNode, 0, 1); // å³å¢ç›Š -> è¾“å‡ºå³

                mergerNode.connect(audioCtx.destination);
                
                isAudioCtxInit = true;
                console.log("AudioContext åˆå§‹åŒ–æˆåŠŸ");
            } catch (e) {
                console.warn("æ— æ³•åˆå§‹åŒ– AudioContext (å¯èƒ½è·¨åŸŸé™åˆ¶):", e);
            }
        }

        function setChannel(mode) {
            // ç¡®ä¿ Context å·²è¿è¡Œ
            if (!isAudioCtxInit) initAudioContext();
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            
            // UI æ›´æ–°
            document.querySelectorAll('.ch-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (!leftGain || !rightGain) return;

            // æ–­å¼€æ‰€æœ‰è¿æ¥ï¼Œé‡æ–°è·¯ç”±
            leftGain.disconnect();
            rightGain.disconnect();

            if (mode === 'stereo') {
                // æ­£å¸¸ï¼šå·¦->å·¦ï¼Œå³->å³
                splitterNode.connect(leftGain, 0);
                splitterNode.connect(rightGain, 1);
                leftGain.connect(mergerNode, 0, 0);
                rightGain.connect(mergerNode, 0, 1);
            } else if (mode === 'left') {
                // åªå¬å·¦ï¼šæŠŠå·¦å£°é“ä¿¡å·åŒæ—¶é€åˆ°è¾“å‡ºçš„å·¦å’Œå³
                // æ–­å¼€å³æº
                splitterNode.disconnect(rightGain); 
                splitterNode.connect(leftGain, 0); // æºå·¦ -> å¢ç›Šå·¦
                
                // å¢ç›Šå·¦ -> è¾“å‡ºå·¦ AND è¾“å‡ºå³
                leftGain.connect(mergerNode, 0, 0);
                leftGain.connect(mergerNode, 0, 1);
            } else if (mode === 'right') {
                // åªå¬å³ï¼šæŠŠå³å£°é“ä¿¡å·åŒæ—¶é€åˆ°è¾“å‡ºçš„å·¦å’Œå³
                splitterNode.disconnect(leftGain);
                splitterNode.connect(rightGain, 1);
                
                rightGain.connect(mergerNode, 0, 0);
                rightGain.connect(mergerNode, 0, 1);
            }
        }

        // ================= 2. æ’­æ”¾ä¸åŠ è½½é€»è¾‘ =================
        function loadVideo(src, type, name) {
            // ä¿å­˜å†å²
            saveHistory(name, src);

            // é‡ç½®çŠ¶æ€
            document.getElementById('audioTrackSection').style.display = 'none';
            updateSubList([]); 

            if (Hls.isSupported() && (type === 'hls' || src.includes('.m3u8'))) {
                hls.loadSource(src);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.play();
                    // åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
                    initAudioContext();
                    // æ£€æµ‹ M3U8 çš„å¤šéŸ³è½¨
                    checkHlsAudioTracks();
                    // æ£€æµ‹ M3U8 çš„å†…ç½®å­—å¹•
                    updateSubList(hls.subtitleTracks, 'hls');
                });
            } else {
                video.src = src;
                video.play();
                initAudioContext();
                // å°è¯•è¯»å–åŸç”Ÿå†…ç½®å­—å¹•
                setTimeout(() => {
                    if(video.textTracks && video.textTracks.length > 0) {
                        updateSubList(video.textTracks, 'native');
                    }
                }, 500);
            }
        }

        // å¤„ç† HLS å¤šéŸ³è½¨ (é’ˆå¯¹ Apple HLS æ ¼å¼çš„å¤šè¯­è¨€)
        function checkHlsAudioTracks() {
            if (hls.audioTracks.length > 1) {
                const section = document.getElementById('audioTrackSection');
                const select = document.getElementById('audioTrackSelect');
                section.style.display = 'block';
                select.innerHTML = '';
                
                hls.audioTracks.forEach((track, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.text = track.name || `éŸ³è½¨ ${index + 1} (${track.lang || 'unk'})`;
                    select.appendChild(opt);
                });

                select.onchange = (e) => {
                    hls.audioTrack = parseInt(e.target.value);
                };
            }
        }

        // å¤„ç†å­—å¹•åˆ—è¡¨ (åˆå¹¶ HLSã€åŸç”Ÿã€å¤–éƒ¨)
        function updateSubList(tracks, type) {
            const select = document.getElementById('subTrackSelect');
            // ä¿ç•™ç¬¬ä¸€ä¸ªâ€œå…³é—­â€å’Œæœ€åä¸€ä¸ªâ€œä¸Šä¼ â€é€»è¾‘ï¼Œè¿™é‡Œç®€åŒ–æ¸…ç©º
            select.innerHTML = '<option value="-1">å…³é—­å­—å¹•</option>';
            
            if (type === 'hls') {
                tracks.forEach((t, i) => {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.text = t.name || `å­—å¹• ${i+1} (${t.lang})`;
                    opt.dataset.type = 'hls';
                    select.appendChild(opt);
                });
            } else if (type === 'native') {
                for (let i = 0; i < tracks.length; i++) {
                    const t = tracks[i];
                    // å¿½ç•¥éšè—çš„
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.text = t.label || `å­—å¹• ${i+1} (${t.language})`;
                    opt.dataset.type = 'native';
                    select.appendChild(opt);
                }
            }
        }

        // å­—å¹•åˆ‡æ¢äº‹ä»¶
        document.getElementById('subTrackSelect').addEventListener('change', (e) => {
            const index = parseInt(e.target.value);
            const opt = e.target.options[e.target.selectedIndex];
            
            // 1. å…³é—­æ‰€æœ‰
            if (hls.subtitleTrack !== undefined) hls.subtitleTrack = -1;
            for(let i=0; i<video.textTracks.length; i++) video.textTracks[i].mode = 'hidden';

            if (index === -1) return;

            // 2. å¯ç”¨é€‰ä¸­çš„
            if (opt.dataset.type === 'hls') {
                hls.subtitleTrack = index;
            } else if (opt.dataset.type === 'native') {
                video.textTracks[index].mode = 'showing';
            }
        });

        // ================= 3. åŸºç¡€äº¤äº’ =================
        const playBtn = document.getElementById('playBtn');
        video.addEventListener('click', togglePlay);
        playBtn.addEventListener('click', togglePlay);

        function togglePlay() {
            if (video.paused) {
                video.play();
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                initAudioContext(); // ç¡®ä¿ AudioContext åœ¨ç”¨æˆ·äº¤äº’åå¯åŠ¨
            } else {
                video.pause();
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
        }

        // è¿›åº¦æ¡
        video.addEventListener('timeupdate', () => {
            const pct = (video.currentTime / video.duration) * 100;
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('timeDisplay').innerText = 
                formatTime(video.currentTime) + (video.duration ? ' / ' + formatTime(video.duration) : '');
        });

        document.getElementById('progressBar').addEventListener('click', (e) => {
            const rect = e.target.getBoundingClientRect();
            const pos = (e.clientX - rect.left) / rect.width;
            video.currentTime = pos * video.duration;
        });

        function formatTime(s) {
            return new Date(s * 1000).toISOString().substr(14, 5);
        }

        // æ‹–æ‹½ä¸Šä¼ 
        const dragBox = document.getElementById('dragBox');
        const fileInput = document.getElementById('videoFile');
        
        dragBox.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        
        dragBox.addEventListener('dragover', (e) => { e.preventDefault(); dragBox.style.background = '#eee'; });
        dragBox.addEventListener('drop', (e) => {
            e.preventDefault();
            dragBox.style.background = '';
            handleFile(e.dataTransfer.files[0]);
        });

        function handleFile(file) {
            if(!file) return;
            const url = URL.createObjectURL(file);
            loadVideo(url, 'file', file.name);
        }

        function loadUrl() {
            const url = document.getElementById('urlInput').value;
            if(url) loadVideo(url, 'url', 'ç½‘ç»œè§†é¢‘');
        }

        // åŠ è½½å¤–éƒ¨å­—å¹•
        document.getElementById('subFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const track = document.getElementById('extTrack');
            track.src = URL.createObjectURL(file);
            // åˆ‡æ¢åˆ°å¤–éƒ¨å­—å¹•
            video.textTracks[0].mode = 'showing'; 
            alert('å·²åŠ è½½å­—å¹•: ' + file.name);
        });

        // è®¾ç½®é¢æ¿åˆ‡æ¢
        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('active');
        }

        function setSpeed(val) {
            video.playbackRate = val;
            document.getElementById('speedVal').innerText = val + 'x';
        }

        function toggleFullscreen() {
            if(!document.fullscreenElement) document.querySelector('.player-wrapper').requestFullscreen();
            else document.exitFullscreen();
        }

        function toggleTheme() {
            const body = document.body;
            body.setAttribute('data-theme', body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
        }

        // å†å²è®°å½•
        function saveHistory(name, url) {
            // ç®€å•å¤„ç†ï¼Œä¸ä½¿ç”¨ LocalStorage ä»¥å…ä»£ç è¿‡é•¿ï¼Œå®é™…ä½¿ç”¨å¯æ·»åŠ 
            const list = document.getElementById('historyList');
            const li = document.createElement('li');
            li.className = 'history-item';
            li.innerHTML = `<span>${name}</span> <span>${new Date().toLocaleTimeString()}</span>`;
            li.onclick = () => loadVideo(url, 'history', name);
            list.prepend(li);
        }
        function clearHistory() { document.getElementById('historyList').innerHTML = ''; }

    </script>
</body>
</html>
