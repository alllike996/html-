<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OmniPlayer Pro v1.3 - å…¨èƒ½æ’­æ”¾å™¨</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.bootcss.com/flv.js/1.5.0/flv.min.js"></script>
    
    <style>
        :root {
            --primary: #4facfe;
            --primary-grad: linear-gradient(to right, #4facfe 0%, #00f2fe 100%);
            --bg-color: #f0f2f5;
            /* å¢åŠ é€æ˜åº¦ä»¥é€å‡ºèƒŒæ™¯å›¾ */
            --card-bg: rgba(255, 255, 255, 0.85); 
            --text-main: #333;
            --panel-bg: rgba(255, 255, 255, 0.90);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --card-bg: rgba(30, 30, 30, 0.85);
            --text-main: #e0e0e0;
            --panel-bg: rgba(30, 30, 30, 0.90);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
        
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: var(--bg-color); 
            /* =========================================
               è¿™é‡Œè®¾ç½®é»˜è®¤èƒŒæ™¯å›¾
               ç¡®ä¿ 0eac.jpg ä¸ html æ–‡ä»¶åœ¨åŒä¸€ç›®å½•ä¸‹
               ========================================= */
            background-image: url('0eac.jpg'); 
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            
            color: var(--text-main); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            padding: 20px; 
            min-height: 100vh; 
            transition: color 0.3s; /* èƒŒæ™¯å›¾åˆ‡æ¢ä¸éœ€è¦è¿‡æ¸¡åŠ¨ç”»ï¼Œé¿å…é—ªçƒ */
        }
        
        /* é¡¶éƒ¨ä¸é€šç”¨ */
        header { 
            width: 100%; max-width: 1000px; display: flex; justify-content: space-between; 
            margin-bottom: 20px; align-items: center; 
            background: var(--card-bg); padding: 15px 20px; border-radius: 12px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(8px); /* æ¯›ç»ç’ƒæ•ˆæœ */
        }
        
        .title-group { display: flex; align-items: center; gap: 10px; }
        h1 { font-size: 1.5rem; background: var(--primary-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
        
        .version-tag {
            font-size: 0.75rem; background: var(--primary); color: white; 
            padding: 2px 8px; border-radius: 12px; font-weight: bold; vertical-align: middle;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .btn { padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; background: transparent; color: var(--text-main); cursor: pointer; display: inline-flex; align-items: center; gap: 5px; transition: 0.2s; }
        .btn:hover { background: rgba(0,0,0,0.05); }
        [data-theme="dark"] .btn:hover { background: rgba(255,255,255,0.1); border-color: #555; }

        /* æ’­æ”¾å™¨å®¹å™¨ */
        .player-wrapper {
            width: 100%; max-width: 1000px; position: relative; aspect-ratio: 16/9;
            background: #000; border-radius: 12px; overflow: hidden; box-shadow: var(--shadow);
        }
        video { width: 100%; height: 100%; object-fit: contain; }

        /* æ§åˆ¶æ  */
        .controls-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: linear-gradient(transparent, rgba(0,0,0,0.9));
            padding: 15px; display: flex; flex-direction: column; gap: 10px;
            opacity: 0; transition: opacity 0.3s;
        }
        .player-wrapper:hover .controls-overlay { opacity: 1; }

        /* è¿›åº¦æ¡ */
        .progress-container { width: 100%; height: 5px; background: rgba(255,255,255,0.3); cursor: pointer; border-radius: 5px; position: relative; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; border-radius: 5px; }

        /* æŒ‰é’®è¡Œ */
        .ctrl-row { display: flex; justify-content: space-between; align-items: center; color: white; }
        .ctrl-group { display: flex; gap: 15px; align-items: center; }
        .icon-btn { cursor: pointer; font-size: 1.1rem; color: #fff; background: none; border: none; }
        .icon-btn:hover { color: var(--primary); }

        /* ====== è®¾ç½®å¼¹çª— ====== */
        .settings-panel {
            position: absolute; bottom: 60px; right: 15px;
            width: 280px; background: var(--panel-bg); color: var(--text-main);
            border-radius: 12px; padding: 15px; display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 10;
            backdrop-filter: blur(12px); max-height: 80%; overflow-y: auto;
        }
        .settings-panel.active { display: block; animation: fadeIn 0.2s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .setting-item { margin-bottom: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); padding-bottom: 10px; }
        .setting-item:last-child { border-bottom: none; margin-bottom: 0; }
        .setting-label { font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; display: block; color: var(--primary); }
        .setting-select { width: 100%; padding: 6px; border-radius: 4px; border: 1px solid #ccc; background: transparent; color: var(--text-main); }
        
        /* å£°é“æŒ‰é’®ç»„ */
        .channel-group { display: flex; gap: 5px; }
        .ch-btn { flex: 1; font-size: 0.8rem; padding: 6px; cursor: pointer; border: 1px solid #ccc; background: transparent; color: var(--text-main); border-radius: 4px; }
        .ch-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ */
        .input-area { width: 100%; max-width: 1000px; margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .drop-zone { border: 2px dashed #ccc; padding: 30px; text-align: center; border-radius: 12px; cursor: pointer; background: var(--card-bg); transition: 0.3s; display: flex; flex-direction: column; justify-content: center; align-items: center; box-shadow: var(--shadow); backdrop-filter: blur(5px); }
        .drop-zone:hover { border-color: var(--primary); transform: translateY(-2px); }
        .url-zone { display: flex; gap: 10px; background: var(--card-bg); padding: 20px; border-radius: 12px; align-items: center; box-shadow: var(--shadow); backdrop-filter: blur(5px); }
        .url-input { flex: 1; padding: 8px; border-radius: 4px; border: 1px solid #ddd; background: transparent; color: var(--text-main); }

        /* å†å²è®°å½• */
        .history-panel { width: 100%; max-width: 1000px; margin-top: 20px; background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: var(--shadow); backdrop-filter: blur(5px); }
        .history-list { list-style: none; max-height: 100px; overflow-y: auto; margin-top: 10px; }
        .history-item { font-size: 0.9rem; padding: 8px 0; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
        .history-item:hover { color: var(--primary); }

        @media (max-width: 768px) { .input-area { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <header>
        <div class="title-group">
            <h1><i class="fas fa-film"></i> OmniPlayer Pro</h1>
            <span class="version-tag">v1.3</span>
        </div>
        <button class="btn" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
    </header>

    <div class="player-wrapper" id="dropArea">
        <video id="video" playsinline crossorigin="anonymous"></video>
        <track id="extTrack" kind="subtitles" label="å¤–éƒ¨å­—å¹•" srclang="zh">
        
        <div class="controls-overlay">
            <div class="progress-container" id="progressBar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="ctrl-row">
                <div class="ctrl-group">
                    <button class="icon-btn" id="playBtn"><i class="fas fa-play"></i></button>
                    <span id="timeDisplay" style="font-size: 0.9rem;">00:00</span>
                    <i class="fas fa-volume-up icon-btn" id="muteBtn"></i>
                    <input type="range" id="volRange" min="0" max="1" step="0.1" value="1" style="width: 80px">
                </div>
                <div class="ctrl-group">
                    <button class="icon-btn" onclick="toggleSettings()" title="è®¾ç½®">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="icon-btn" onclick="toggleFullscreen()"><i class="fas fa-expand"></i></button>
                </div>
            </div>
        </div>

        <div class="settings-panel" id="settingsPanel">
            <div class="setting-item">
                <label class="setting-label">ğŸ”Š å£°é“æ¨¡å¼ (Web Audio)</label>
                <div class="channel-group">
                    <button class="ch-btn active" onclick="setChannel('stereo')">ç«‹ä½“å£°</button>
                    <button class="ch-btn" onclick="setChannel('left')">å·¦</button>
                    <button class="ch-btn" onclick="setChannel('right')">å³</button>
                </div>
            </div>

            <!-- èƒŒæ™¯è®¾ç½® v1.3 æ›´æ–° -->
            <div class="setting-item">
                <label class="setting-label">ğŸ–¼ï¸ èƒŒæ™¯è®¾ç½® (æœ¬åœ°)</label>
                <button class="btn" style="width:100%; font-size:0.8rem; justify-content: center;" onclick="document.getElementById('bgInput').click()">
                    <i class="fas fa-image"></i> ä¸´æ—¶æ›´æ¢èƒŒæ™¯
                </button>
                <button class="btn" style="width:100%; font-size:0.8rem; margin-top:5px; justify-content: center; color: #ff6b6b;" onclick="resetBackground()">
                    <i class="fas fa-undo"></i> æ¢å¤é»˜è®¤ (0eac.jpg)
                </button>
                <div style="font-size:0.7rem; color:#888; margin-top:4px; text-align:center;">*ä»…å½“å‰ä¼šè¯æœ‰æ•ˆï¼Œä¸ä¿®æ”¹æºæ–‡ä»¶</div>
            </div>

            <div class="setting-item" id="audioTrackSection" style="display:none;">
                <label class="setting-label">ğŸµ åˆ‡æ¢éŸ³è½¨ (HLS)</label>
                <select id="audioTrackSelect" class="setting-select"></select>
            </div>

            <div class="setting-item">
                <label class="setting-label">ğŸ’¬ å­—å¹•é€‰æ‹©</label>
                <select id="subTrackSelect" class="setting-select">
                    <option value="-1">å…³é—­å­—å¹•</option>
                </select>
                <button class="btn" style="width:100%; margin-top:5px; font-size:0.8rem; justify-content: center;" onclick="document.getElementById('subFile').click()">
                    <i class="fas fa-upload"></i> åŠ è½½ .vtt/.srt
                </button>
            </div>

            <div class="setting-item">
                <label class="setting-label">ğŸš€ æ’­æ”¾é€Ÿåº¦: <span id="speedVal">1.0x</span></label>
                <input type="range" min="0.5" max="2" step="0.25" value="1" style="width:100%" oninput="setSpeed(this.value)">
            </div>
        </div>
    </div>

    <div class="input-area">
        <div class="drop-zone" id="dragBox">
            <i class="fas fa-cloud-upload-alt fa-2x" style="color:var(--primary); margin-bottom:10px;"></i>
            <p>æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°æ­¤å¤„</p>
            <p style="font-size:0.8rem; color:#888;">MP4, MKV, M3U8, WEBM</p>
        </div>
        <div class="url-zone">
            <input type="text" id="urlInput" class="url-input" placeholder="è¾“å…¥ M3U8 / MP4 é“¾æ¥...">
            <button class="btn" onclick="loadUrl()"><i class="fas fa-play"></i></button>
        </div>
    </div>

    <div class="history-panel">
        <h4 style="margin-bottom:10px; border-bottom:1px solid #ddd; padding-bottom:5px;">ğŸ•’ æ’­æ”¾å†å²</h4>
        <ul class="history-list" id="historyList"></ul>
        <button class="btn" onclick="clearHistory()" style="font-size:0.8rem; margin-top:5px;">æ¸…ç©ºå†å²</button>
    </div>

    <input type="file" id="videoFile" style="display:none" accept="video/*,.mkv,.flv">
    <input type="file" id="subFile" style="display:none" accept=".vtt,.srt">
    <input type="file" id="bgInput" style="display:none" accept="image/*">

    <script>
        // ================= å˜é‡å®šä¹‰ =================
        const video = document.getElementById('video');
        const hls = new Hls();
        let audioCtx, sourceNode, splitterNode, mergerNode, leftGain, rightGain;
        let isAudioCtxInit = false;

        // ================= 1. èƒŒæ™¯æ§åˆ¶ (v1.3 ä¿®æ”¹) =================
        const bgInput = document.getElementById('bgInput');
        
        // æ›´æ¢èƒŒæ™¯ (æœ¬åœ°å†…å­˜æ“ä½œ)
        bgInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    document.body.style.backgroundImage = `url(${evt.target.result})`;
                };
                reader.readAsDataURL(file);
            }
        });

        // æ¢å¤é»˜è®¤ (æŒ‡å‘åŒç›®å½•ä¸‹çš„ 0eac.jpg)
        function resetBackground() {
            document.body.style.backgroundImage = "url('0eac.jpg')";
        }

        // ================= 2. Web Audio API (å£°é“) =================
        function initAudioContext() {
            if (isAudioCtxInit) return;
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                sourceNode = audioCtx.createMediaElementSource(video);
                splitterNode = audioCtx.createChannelSplitter(2);
                mergerNode = audioCtx.createChannelMerger(2);
                leftGain = audioCtx.createGain();
                rightGain = audioCtx.createGain();

                sourceNode.connect(splitterNode);
                splitterNode.connect(leftGain, 0); 
                splitterNode.connect(rightGain, 1); 
                leftGain.connect(mergerNode, 0, 0);  
                rightGain.connect(mergerNode, 0, 1); 
                mergerNode.connect(audioCtx.destination);
                
                isAudioCtxInit = true;
            } catch (e) { console.warn("AudioContext Init Failed:", e); }
        }

        function setChannel(mode) {
            if (!isAudioCtxInit) initAudioContext();
            if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
            
            document.querySelectorAll('.ch-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');

            if (!leftGain || !rightGain) return;
            leftGain.disconnect();
            rightGain.disconnect();

            if (mode === 'stereo') {
                splitterNode.connect(leftGain, 0);
                splitterNode.connect(rightGain, 1);
                leftGain.connect(mergerNode, 0, 0);
                rightGain.connect(mergerNode, 0, 1);
            } else if (mode === 'left') {
                splitterNode.disconnect(rightGain); 
                splitterNode.connect(leftGain, 0); 
                leftGain.connect(mergerNode, 0, 0);
                leftGain.connect(mergerNode, 0, 1);
            } else if (mode === 'right') {
                splitterNode.disconnect(leftGain);
                splitterNode.connect(rightGain, 1);
                rightGain.connect(mergerNode, 0, 0);
                rightGain.connect(mergerNode, 0, 1);
            }
        }

        // ================= 3. åŠ è½½é€»è¾‘ =================
        function loadVideo(src, type, name) {
            saveHistory(name, src);
            document.getElementById('audioTrackSection').style.display = 'none';
            updateSubList([]); 

            if (Hls.isSupported() && (type === 'hls' || src.includes('.m3u8'))) {
                hls.loadSource(src);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    video.play();
                    initAudioContext();
                    checkHlsAudioTracks();
                    updateSubList(hls.subtitleTracks, 'hls');
                });
            } else {
                video.src = src;
                video.play();
                initAudioContext();
                setTimeout(() => {
                    if(video.textTracks && video.textTracks.length > 0) {
                        updateSubList(video.textTracks, 'native');
                    }
                }, 500);
            }
        }

        function checkHlsAudioTracks() {
            if (hls.audioTracks.length > 1) {
                const section = document.getElementById('audioTrackSection');
                const select = document.getElementById('audioTrackSelect');
                section.style.display = 'block';
                select.innerHTML = '';
                hls.audioTracks.forEach((track, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.text = track.name || `éŸ³è½¨ ${index + 1}`;
                    select.appendChild(opt);
                });
                select.onchange = (e) => { hls.audioTrack = parseInt(e.target.value); };
            }
        }

        function updateSubList(tracks, type) {
            const select = document.getElementById('subTrackSelect');
            select.innerHTML = '<option value="-1">å…³é—­å­—å¹•</option>';
            if (type === 'hls') {
                tracks.forEach((t, i) => {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.text = t.name || `å­—å¹• ${i+1}`;
                    opt.dataset.type = 'hls';
                    select.appendChild(opt);
                });
            } else if (type === 'native') {
                for (let i = 0; i < tracks.length; i++) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.text = tracks[i].label || `å­—å¹• ${i+1}`;
                    opt.dataset.type = 'native';
                    select.appendChild(opt);
                }
            }
        }

        document.getElementById('subTrackSelect').addEventListener('change', (e) => {
            const index = parseInt(e.target.value);
            const opt = e.target.options[e.target.selectedIndex];
            if (hls.subtitleTrack !== undefined) hls.subtitleTrack = -1;
            for(let i=0; i<video.textTracks.length; i++) video.textTracks[i].mode = 'hidden';
            if (index === -1) return;
            if (opt.dataset.type === 'hls') hls.subtitleTrack = index;
            else if (opt.dataset.type === 'native') video.textTracks[index].mode = 'showing';
        });

        // ================= 4. åŸºç¡€äº¤äº’ =================
        const playBtn = document.getElementById('playBtn');
        video.addEventListener('click', togglePlay);
        playBtn.addEventListener('click', togglePlay);

        function togglePlay() {
            if (video.paused) {
                video.play();
                playBtn.innerHTML = '<i class="fas fa-pause"></i>';
                initAudioContext();
            } else {
                video.pause();
                playBtn.innerHTML = '<i class="fas fa-play"></i>';
            }
        }

        video.addEventListener('timeupdate', () => {
            const pct = (video.currentTime / video.duration) * 100;
            document.getElementById('progressFill').style.width = pct + '%';
            document.getElementById('timeDisplay').innerText = 
                formatTime(video.currentTime) + (video.duration ? ' / ' + formatTime(video.duration) : '');
        });

        document.getElementById('progressBar').addEventListener('click', (e) => {
            const rect = e.target.getBoundingClientRect();
            video.currentTime = ((e.clientX - rect.left) / rect.width) * video.duration;
        });

        function formatTime(s) {
            return new Date(s * 1000).toISOString().substr(14, 5);
        }

        const dragBox = document.getElementById('dragBox');
        const fileInput = document.getElementById('videoFile');
        dragBox.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        dragBox.addEventListener('dragover', (e) => { e.preventDefault(); });
        dragBox.addEventListener('drop', (e) => { e.preventDefault(); handleFile(e.dataTransfer.files[0]); });

        function handleFile(file) {
            if(!file) return;
            loadVideo(URL.createObjectURL(file), 'file', file.name);
        }

        function loadUrl() {
            const url = document.getElementById('urlInput').value;
            if(url) loadVideo(url, 'url', 'ç½‘ç»œè§†é¢‘');
        }

        document.getElementById('subFile').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if(!file) return;
            document.getElementById('extTrack').src = URL.createObjectURL(file);
            video.textTracks[0].mode = 'showing'; 
            alert('å·²åŠ è½½å­—å¹•: ' + file.name);
        });

        function toggleSettings() {
            document.getElementById('settingsPanel').classList.toggle('active');
        }

        function setSpeed(val) {
            video.playbackRate = val;
            document.getElementById('speedVal').innerText = val + 'x';
        }

        function toggleFullscreen() {
            const wrapper = document.querySelector('.player-wrapper');
            if(!document.fullscreenElement) wrapper.requestFullscreen();
            else document.exitFullscreen();
        }

        function toggleTheme() {
            const body = document.body;
            body.setAttribute('data-theme', body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
        }

        function saveHistory(name, url) {
            const list = document.getElementById('historyList');
            const li = document.createElement('li');
            li.className = 'history-item';
            li.innerHTML = `<span>${name}</span> <span>${new Date().toLocaleTimeString()}</span>`;
            li.onclick = () => loadVideo(url, 'history', name);
            list.prepend(li);
        }
        function clearHistory() { document.getElementById('historyList').innerHTML = ''; }

    </script>
</body>
</html>
