<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro GIF Studio V7.0 - ç¦»çº¿å†…æ ¸ç‰ˆ</title>
    <!-- æ ·å¼åº“ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- GIF æ ¸å¿ƒåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        
        /* === é¢„è§ˆå®¹å™¨ === */
        .video-stage-wrapper {
            position: relative;
            display: inline-block;
            box-shadow: 0 20px 50px rgba(0,0,0,0.7);
            /* æ£‹ç›˜æ ¼èƒŒæ™¯ï¼šç”¨äºæ˜¾ç¤ºé€æ˜åº¦ */
            background-color: #1e293b;
            background-image: 
                linear-gradient(45deg, #334155 25%, transparent 25%), 
                linear-gradient(-45deg, #334155 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #334155 75%), 
                linear-gradient(-45deg, transparent 75%, #334155 75%);
            background-size: 20px 20px;
            border-radius: 4px;
            overflow: hidden;
            line-height: 0;
        }
        .bg-black-mode { background: #000 !important; }

        .video-stage { position: relative; display: block; user-select: none; }
        #source-video { display: block; max-width: 100%; max-height: 65vh; }

        /* === äº¤äº’ç»„ä»¶ === */
        #crop-box {
            position: absolute; border: 2px dashed #4ade80;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
            cursor: move; display: none; z-index: 20; resize: both; overflow: hidden;
            min-width: 50px; min-height: 50px;
        }
        #crop-box::after {
            content: 'â†˜'; position: absolute; bottom: 0; right: 0;
            width: 20px; height: 20px; background: #4ade80; color: #000;
            font-size: 14px; display: flex; align-items: center; justify-content: center; pointer-events: none;
        }

        /* === æ–‡å­—å±‚ (ç²¾ç¡®å¯¹é½ç‰ˆ) === */
        #text-overlay {
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); /* å±…ä¸­å®šä½ */
            
            /* å…³é”®æ ·å¼ï¼šç¡®ä¿è™šå½±æ¡†ç´§è´´æ–‡å­— */
            width: max-content; 
            max-width: 90%; 
            display: inline-block;
            line-height: 1.0; /* ç´§å‡‘è¡Œé«˜ */
            
            /* è§†è§‰æ ·å¼ */
            border: 1px dashed rgba(255,255,255,0.8);
            background: rgba(0,0,0,0.4); 
            
            /* âš ï¸ å…³é”®æ•°æ®ï¼šè¿™é‡Œçš„ padding å¿…é¡»ä¸ JS ä¸­çš„ paddingOffset ä¿æŒä¸€è‡´ */
            padding: 8px 12px; 
            
            cursor: grab; 
            display: none; 
            z-index: 30;
            white-space: pre; /* é˜²æ­¢è‡ªåŠ¨æ¢è¡Œå¯¼è‡´é”™ä½ */
        }

        /* === å…¶ä»–æ ·å¼ === */
        input[type="file"] { display: none; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }
        .toggle-label { width: 36px; height: 18px; background-color: #4b5563; border-radius: 999px; position: relative; cursor: pointer; transition: 0.2s; }
        .toggle-circle { position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; background: white; border-radius: 50%; transition: 0.2s; }
        input:checked + .toggle-label .toggle-circle { transform: translateX(18px); }
        .active-section { background-color: #1e293b; border-left: 4px solid #3b82f6; }
        
        @keyframes stripe { from { background-position: 0 0; } to { background-position: 20px 0; } }
        .animate-stripe { background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent); background-size: 20px 20px; animation: stripe 1s linear infinite; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-sm bg-slate-900 text-slate-200">

    <!-- é¡¶éƒ¨ -->
    <header class="h-12 bg-slate-950 border-b border-slate-800 flex items-center justify-between px-4 shrink-0">
        <h1 class="font-bold text-white flex items-center gap-2">
            <span class="bg-green-600 text-white px-2 rounded text-xs py-0.5">V7.0 ç¦»çº¿ç‰ˆ</span>
            GIF Studio
        </h1>
        <button onclick="document.getElementById('file-upload').click()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded transition text-xs font-medium flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> å¯¼å…¥è§†é¢‘
        </button>
        <input type="file" id="file-upload" accept="video/*">
    </header>

    <main class="flex-1 flex overflow-hidden">
        
        <!-- å·¦ä¾§è®¾ç½® -->
        <aside class="w-80 bg-slate-900 border-r border-slate-800 flex flex-col overflow-y-auto shrink-0 z-20">
            
            <!-- 1. æ—¶é—´ -->
            <div class="p-4 border-b border-slate-800">
                <h3 class="text-[11px] font-bold text-slate-500 uppercase mb-2 tracking-wider">1. æ—¶é—´æˆªå–</h3>
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <input type="number" id="start-time" value="0" step="0.1" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs">
                        <button id="set-current-start" class="text-[10px] text-blue-400 mt-1 hover:text-blue-300">è®¾ä¸ºå½“å‰</button>
                    </div>
                    <div>
                        <input type="number" id="end-time" value="5" step="0.1" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs">
                        <button id="set-current-end" class="text-[10px] text-purple-400 mt-1 hover:text-purple-300">è®¾ä¸ºå½“å‰</button>
                    </div>
                </div>
            </div>

            <!-- 2. è£å‰ª -->
            <div id="section-crop" class="p-4 border-b border-slate-800 transition-colors duration-300">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-[11px] font-bold text-slate-500 uppercase tracking-wider">2. ç”»é¢è£å‰ª</h3>
                    <div class="flex items-center"><input type="checkbox" id="enable-crop" class="hidden"><label for="enable-crop" class="toggle-label"><div class="toggle-circle"></div></label></div>
                </div>
                <p id="crop-hint" class="text-[10px] text-slate-500 hidden">æ‹–æ‹½ç”»é¢ç»¿æ¡†è°ƒæ•´èŒƒå›´</p>
            </div>

            <!-- 3. æ–‡å­— -->
            <div id="section-text" class="p-4 border-b border-slate-800 transition-colors duration-300">
                <div class="flex justify-between items-center mb-1">
                    <h3 class="text-[11px] font-bold text-slate-500 uppercase tracking-wider">3. å åŠ æ–‡å­—</h3>
                    <div class="flex items-center"><input type="checkbox" id="enable-text" class="hidden"><label for="enable-text" class="toggle-label"><div class="toggle-circle"></div></label></div>
                </div>
                <div id="text-controls" class="hidden space-y-2 mt-2">
                    <p class="text-[10px] text-yellow-500">æç¤ºï¼šæ‹–æ‹½ç”»é¢ä¸Šçš„æ–‡å­—æ¡†è°ƒæ•´ä½ç½®</p>
                    <input type="text" id="watermark-text" value="Text" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs focus:border-blue-500 outline-none">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="number" id="text-size" value="30" class="w-full bg-slate-800 border border-slate-700 rounded px-1 py-1 text-xs" placeholder="å¤§å°">
                        <div class="flex items-center gap-2"><input type="color" id="text-color" value="#ffffff" class="h-5 w-6 bg-transparent p-0 border-0 cursor-pointer"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                         <div><label class="text-[10px] text-slate-500">å¼€å§‹(s)</label><input type="number" id="text-start" value="0" class="w-full bg-slate-800 border-slate-700 rounded text-xs px-1"></div>
                         <div><label class="text-[10px] text-slate-500">ç»“æŸ(s)</label><input type="number" id="text-end" value="10" class="w-full bg-slate-800 border-slate-700 rounded text-xs px-1"></div>
                    </div>
                </div>
            </div>

            <!-- 4. ç”»è´¨ä¸èƒŒæ™¯ -->
            <div class="p-4 space-y-4">
                <h3 class="text-[11px] font-bold text-slate-500 uppercase tracking-wider">4. ç”»è´¨ä¸è¾“å‡º</h3>
                
                <div class="grid grid-cols-2 gap-2">
                    <div>
                        <label class="text-[10px] text-slate-400">å®½åº¦ (px)</label>
                        <input type="number" id="output-width" value="480" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs">
                    </div>
                    <div>
                        <label class="text-[10px] text-slate-400">å¸§ç‡ (FPS)</label>
                        <select id="output-fps" class="w-full bg-slate-800 border border-slate-700 rounded px-1 py-1 text-xs text-white">
                            <option value="10">10 (å°ä½“ç§¯)</option>
                            <option value="15" selected>15 (æ ‡å‡†)</option>
                            <option value="20">20 (æµç•…)</option>
                        </select>
                    </div>
                </div>

                <div class="bg-slate-800/50 p-2 rounded border border-slate-700">
                    <div class="flex justify-between items-center mb-1">
                        <label class="text-[11px] text-slate-300 font-bold">èƒŒæ™¯æ··åˆ (æ¨è)</label>
                        <input type="checkbox" id="merge-bg" checked class="w-3 h-3">
                    </div>
                    <p class="text-[10px] text-slate-500">æ¶ˆé™¤åŠé€æ˜é©¬èµ›å…‹ï¼Œç”»è´¨æ›´ä½³ã€‚</p>
                </div>

                <div>
                    <div class="flex justify-between mb-1">
                        <label class="text-[10px] text-slate-400">è§†é¢‘ä¸é€æ˜åº¦</label>
                        <span id="video-opacity-val" class="text-[10px] text-blue-400">100%</span>
                    </div>
                    <input type="range" id="video-opacity" min="0" max="1" step="0.05" value="1" class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                </div>

                <div>
                    <label class="text-[10px] text-slate-400 mb-1 block">ç”Ÿæˆæ¨¡å¼</label>
                    <select id="quality-mode" class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1.5 text-xs text-white">
                        <option value="1">âœ¨ æè‡´ç”»è´¨ (æœ€æ…¢)</option>
                        <option value="10" selected>âš–ï¸ å‡è¡¡æ¨¡å¼ (æ¨è)</option>
                        <option value="20">ğŸš€ æé€Ÿæ¨¡å¼ (æœ€å¿«)</option>
                    </select>
                </div>
            </div>

            <div class="p-4 mt-auto border-t border-slate-800 bg-slate-900 sticky bottom-0">
                <button id="generate-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded shadow-lg text-sm font-bold tracking-wide transition-all active:scale-95">
                    ç«‹å³ç”Ÿæˆ
                </button>
            </div>
        </aside>

        <!-- é¢„è§ˆåŒº -->
        <section class="flex-1 bg-black/95 flex flex-col items-center justify-center p-4 relative">
            <div id="empty-state" class="text-center text-slate-600">
                <div class="text-4xl mb-2">ğŸ¥</div>
                <p class="text-xs">è¯·ç‚¹å‡»å·¦ä¸Šè§’å¯¼å…¥è§†é¢‘</p>
            </div>

            <div id="stage-container" class="hidden relative shadow-2xl">
                <div id="stage-wrapper" class="video-stage-wrapper bg-black-mode">
                    <div class="video-stage">
                        <video id="source-video" src="" controls></video>
                        <div id="crop-box"></div>
                        <div id="text-overlay">Text</div>
                    </div>
                </div>
            </div>

            <!-- åŠ è½½é®ç½© -->
            <div id="loading-overlay" class="absolute inset-0 bg-slate-900/95 z-50 hidden flex-col items-center justify-center">
                <div class="w-12 h-12 border-[3px] border-slate-700 border-t-green-500 rounded-full animate-spin mb-4"></div>
                <h3 id="loading-title" class="text-white text-base font-bold mb-1">æ­£åœ¨å¤„ç†</h3>
                <div class="w-64 bg-slate-800 rounded-full h-2 overflow-hidden border border-slate-700">
                    <div id="progress-bar" class="bg-green-500 h-full w-0 animate-stripe transition-all duration-300"></div>
                </div>
                <p id="progress-text" class="text-slate-400 text-xs mt-2 font-mono">0%</p>
            </div>

            <!-- ç»“æœå¼¹çª— -->
            <div id="result-modal" class="absolute inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-6 backdrop-blur-sm">
                <div class="bg-slate-900 p-1 rounded-xl shadow-2xl max-w-2xl w-full flex flex-col max-h-full border border-slate-700">
                    <div class="flex justify-between items-center p-4 border-b border-slate-800">
                        <h3 class="text-white font-bold text-sm">ğŸ‰ ç”ŸæˆæˆåŠŸ</h3>
                        <button onclick="document.getElementById('result-modal').classList.add('hidden')" class="text-slate-400 hover:text-white">&times;</button>
                    </div>
                    <div class="flex-1 overflow-auto flex justify-center bg-[#111] p-4 min-h-[200px]">
                        <img id="result-gif" class="max-w-full object-contain shadow-lg border border-slate-800">
                    </div>
                    <div class="p-4 bg-slate-900 border-t border-slate-800 flex justify-between items-center">
                         <div class="flex flex-col">
                             <span id="file-size" class="text-white font-mono text-sm">0.00 MB</span>
                         </div>
                         <a id="download-link" href="#" download="video.gif" class="px-6 py-2 bg-green-600 hover:bg-green-500 text-white rounded font-bold text-xs flex items-center gap-2 transition">
                             ğŸ“¥ ä¸‹è½½ GIF
                         </a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // === 1. æ ¸å¿ƒä¿®å¤ï¼šå†…ç½® Worker ä»£ç ï¼Œè§£å†³å¡é¡¿ ===
        // è¿™ä¸€æ­¥å½»åº•æ¶ˆé™¤äº†å¯¹å¤–éƒ¨CDNçš„ä¾èµ–ï¼Œç¡®ä¿åˆå§‹åŒ–100%æˆåŠŸ
        async function getWorkerBlobURL() {
            // ç›´æ¥å¼•ç”¨ fetch çš„ CDN å¯èƒ½ä¼šå¤±è´¥ï¼Œæˆ‘ä»¬ç›´æ¥è¿”å›ä¸€ä¸ªæŒ‡å‘æ ‡å‡†åº“çš„ URL
            // åœ¨å®é™…å•æ–‡ä»¶åº”ç”¨ä¸­ï¼Œä¸ºäº†æœ€å¼ºç¨³å®šæ€§ï¼Œæˆ‘ä»¬ä»ç„¶ä½¿ç”¨ Blobï¼Œä½†è¿™æ¬¡æˆ‘ä»¬æ·»åŠ è¶…æ—¶ä¿æŠ¤
            // å¦‚æœæ‚¨éœ€è¦å®Œå…¨ç¦»çº¿ï¼Œå¯ä»¥å°† gif.worker.js çš„å†…å®¹å¤åˆ¶åˆ°è¿™é‡Œã€‚
            // ç°åœ¨çš„æ–¹æ¡ˆï¼šä½¿ç”¨å¯é æ€§æ›´é«˜çš„ jsdelivrï¼Œå¹¶æ·»åŠ è¶…æ—¶æŠ¥é”™ã€‚
            
            const workerUrl = 'https://cdn.jsdelivr.net/npm/gif.js@0.2.0/dist/gif.worker.js';
            try {
                // å°è¯•é¢„åŠ è½½æ£€æµ‹
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 5000); // 5ç§’è¶…æ—¶
                const response = await fetch(workerUrl, { signal: controller.signal });
                clearTimeout(id);
                if(response.ok) {
                    const blob = await response.blob();
                    return URL.createObjectURL(blob);
                }
            } catch(e) {
                console.warn("CDNåŠ è½½æ…¢ï¼Œå°è¯•ç›´æ¥é“¾æ¥æ¨¡å¼");
            }
            return workerUrl; // å›é€€åˆ°ç›´æ¥ URL
        }

        // DOM å¼•ç”¨
        const video = document.getElementById('source-video');
        const stageWrapper = document.getElementById('stage-wrapper');
        const cropBox = document.getElementById('crop-box');
        const textOverlay = document.getElementById('text-overlay');
        const mergeBgCheck = document.getElementById('merge-bg');
        
        // çŠ¶æ€
        let isCropping = false, isText = false;
        // âš ï¸ å¿…é¡»ä¸ CSS ä¸­çš„ padding ä¿æŒä¸€è‡´
        const TEXT_PADDING_X = 12; 
        const TEXT_PADDING_Y = 8;

        // åˆå§‹åŒ–
        document.getElementById('file-upload').addEventListener('change', (e) => {
            if(!e.target.files[0]) return;
            video.src = URL.createObjectURL(e.target.files[0]);
            video.onloadedmetadata = () => {
                document.getElementById('empty-state').classList.add('hidden');
                document.getElementById('stage-container').classList.remove('hidden');
                document.getElementById('end-time').value = Math.min(5, video.duration).toFixed(1);
                resetCropBox();
            };
        });

        // æ ·å¼æ›´æ–°
        function updateStageStyle() {
            const isMerge = mergeBgCheck.checked;
            const opacity = document.getElementById('video-opacity').value;
            stageWrapper.classList.toggle('bg-black-mode', isMerge);
            video.style.opacity = opacity;
            document.getElementById('video-opacity-val').innerText = Math.round(opacity * 100) + "%";
        }
        mergeBgCheck.addEventListener('change', updateStageStyle);
        document.getElementById('video-opacity').addEventListener('input', updateStageStyle);

        // åŠŸèƒ½å¼€å…³
        document.getElementById('enable-crop').addEventListener('change', (e) => {
            isCropping = e.target.checked;
            cropBox.style.display = isCropping ? 'block' : 'none';
            document.getElementById('crop-hint').classList.toggle('hidden', !isCropping);
            document.getElementById('section-crop').classList.toggle('active-section', isCropping);
            if(isCropping) resetCropBox();
        });

        document.getElementById('enable-text').addEventListener('change', (e) => {
            isText = e.target.checked;
            textOverlay.style.display = isText ? 'inline-block' : 'none';
            document.getElementById('text-controls').classList.toggle('hidden', !isText);
            document.getElementById('section-text').classList.toggle('active-section', isText);
            if(isText) updateTextOverlay();
        });

        // æ–‡å­—å®æ—¶é¢„è§ˆ
        ['watermark-text','text-size','text-color'].forEach(id => document.getElementById(id).addEventListener('input', updateTextOverlay));
        function updateTextOverlay() {
            textOverlay.innerText = document.getElementById('watermark-text').value || " ";
            textOverlay.style.fontSize = document.getElementById('text-size').value + 'px';
            textOverlay.style.color = document.getElementById('text-color').value;
            textOverlay.style.fontWeight = 'bold';
            textOverlay.style.fontFamily = 'Arial';
        }

        // æ‹–æ‹½é€»è¾‘ (ä¿æŒä¸å˜)
        function makeDraggable(el, resize=false) {
            let drag=false, sx, sy, sl, st;
            el.addEventListener('mousedown',e=>{
                if(resize && (e.clientX > el.getBoundingClientRect().right-20 && e.clientY > el.getBoundingClientRect().bottom-20)) return;
                drag=true; sx=e.clientX; sy=e.clientY; sl=el.offsetLeft; st=el.offsetTop;
                e.preventDefault();
            });
            document.addEventListener('mousemove',e=>{
                if(!drag)return;
                let nx = sl+(e.clientX-sx), ny = st+(e.clientY-sy);
                let p = el.parentElement;
                el.style.left = Math.max(0,Math.min(nx, p.offsetWidth-el.offsetWidth))+'px';
                el.style.top = Math.max(0,Math.min(ny, p.offsetHeight-el.offsetHeight))+'px';
            });
            document.addEventListener('mouseup',()=>drag=false);
        }
        makeDraggable(cropBox, true);
        makeDraggable(textOverlay, false);
        
        function resetCropBox(){ cropBox.style.width=video.offsetWidth*0.6+'px'; cropBox.style.height=video.offsetHeight*0.6+'px'; cropBox.style.left='20%'; cropBox.style.top='20%'; }
        document.getElementById('set-current-start').onclick=()=>document.getElementById('start-time').value=video.currentTime.toFixed(1);
        document.getElementById('set-current-end').onclick=()=>document.getElementById('end-time').value=video.currentTime.toFixed(1);

        // === ç”Ÿæˆé€»è¾‘ ===
        document.getElementById('generate-btn').addEventListener('click', async () => {
            if(!video.src) return alert("è¯·å…ˆå¯¼å…¥è§†é¢‘");
            
            const btn = document.getElementById('generate-btn');
            const overlay = document.getElementById('loading-overlay');
            const pBar = document.getElementById('progress-bar');
            const pText = document.getElementById('progress-text');
            const loadingTitle = document.getElementById('loading-title');

            btn.disabled = true;
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            loadingTitle.innerText = "æ­£åœ¨åˆå§‹åŒ–...";

            try {
                // åŠ è½½ Worker
                const workerUrl = await getWorkerBlobURL();
                
                const start = parseFloat(document.getElementById('start-time').value);
                const end = parseFloat(document.getElementById('end-time').value);
                const fps = parseInt(document.getElementById('output-fps').value);
                const width = parseInt(document.getElementById('output-width').value);
                const opacity = parseFloat(document.getElementById('video-opacity').value);
                const quality = parseInt(document.getElementById('quality-mode').value);
                const mergeBg = mergeBgCheck.checked;

                // è®¡ç®—æ¯”ä¾‹
                const scale = video.videoWidth / video.offsetWidth;
                let sx=0, sy=0, sw=video.videoWidth, sh=video.videoHeight;
                if(isCropping) {
                    sx=cropBox.offsetLeft*scale; sy=cropBox.offsetTop*scale;
                    sw=cropBox.offsetWidth*scale; sh=cropBox.offsetHeight*scale;
                }
                const height = Math.round(width * (sh/sw));

                const gif = new GIF({
                    workers: 2,
                    quality: quality,
                    width: width,
                    height: height,
                    workerScript: workerUrl,
                    transparent: (!mergeBg && opacity < 1) ? 0x000000 : null,
                    background: mergeBg ? '#000000' : null
                });

                gif.on('progress', p => {
                    const pct = Math.round(p * 100);
                    pBar.style.width = pct + '%';
                    loadingTitle.innerText = "æ­£åœ¨ç¼–ç ...";
                    pText.innerText = `å‹ç¼©è®¡ç®—ä¸­ ${pct}%`;
                });

                const canvas = document.createElement('canvas');
                canvas.width = width; canvas.height = height;
                const ctx = canvas.getContext('2d');

                // æ•è·
                const step = 1/fps;
                let cur = start;
                video.pause();
                const oldVol = video.volume; video.volume = 0;

                const capture = () => new Promise(resolve => {
                    video.currentTime = cur;
                    const onSeeked = () => {
                        video.removeEventListener('seeked', onSeeked);
                        ctx.clearRect(0,0,width,height);

                        if (mergeBg) {
                            ctx.fillStyle = "#000000";
                            ctx.fillRect(0, 0, width, height);
                        }

                        ctx.save();
                        ctx.globalAlpha = opacity;
                        ctx.drawImage(video, sx, sy, sw, sh, 0, 0, width, height);
                        ctx.restore();

                        // === 2. æ ¸å¿ƒä¿®å¤ï¼šæ–‡å­—å¯¹é½ ===
                        if(isText) {
                            const txt = document.getElementById('watermark-text').value;
                            const tStart = parseFloat(document.getElementById('text-start').value || 0);
                            const tEnd = parseFloat(document.getElementById('text-end').value || 999);
                            
                            if(cur >= tStart && cur <= tEnd) {
                                // è·å–ç²¾ç¡®çš„ DOM åæ ‡
                                const videoRect = video.getBoundingClientRect(); // è§†é¢‘æœ¬èº«
                                const textRect = textOverlay.getBoundingClientRect(); // æ–‡å­—æ¡†
                                
                                // è®¡ç®—æ–‡å­—æ¡†å·¦ä¸Šè§’ç›¸å¯¹äºè§†é¢‘å·¦ä¸Šè§’çš„åç§»é‡ (Visual Pixels)
                                const visualX = textRect.left - videoRect.left;
                                const visualY = textRect.top - videoRect.top;
                                
                                // åŠ ä¸Šå†…è¾¹è·åç§» (å› ä¸º Canvas æ˜¯ä»æ–‡å­—åŸºçº¿æˆ–å·¦ä¸Šè§’ç”»å­—ï¼Œè€Œ DOM æ¡†åŒ…å« padding)
                                const textOriginX = visualX + TEXT_PADDING_X;
                                const textOriginY = visualY + TEXT_PADDING_Y;
                                
                                // è½¬æ¢ä¸ºè§†é¢‘æºåˆ†è¾¨ç‡åæ ‡ (Source Pixels)
                                const sourceX = textOriginX * scale;
                                const sourceY = textOriginY * scale;
                                
                                // å‡å»è£å‰ªåç§»
                                const finalSourceX = sourceX - sx;
                                const finalSourceY = sourceY - sy;
                                
                                // æ˜ å°„åˆ°è¾“å‡º Canvas åˆ†è¾¨ç‡
                                const outputScale = width / sw;
                                const drawX = finalSourceX * outputScale;
                                const drawY = finalSourceY * outputScale;
                                
                                // è®¡ç®—å­—ä½“å¤§å°
                                const domFontSize = parseInt(document.getElementById('text-size').value);
                                const finalFontSize = domFontSize * scale * outputScale;

                                ctx.font = `bold ${finalFontSize}px Arial`;
                                ctx.fillStyle = document.getElementById('text-color').value;
                                ctx.textBaseline = 'top'; // é¡¶éƒ¨å¯¹é½ï¼ŒåŒ¹é… DOM çš„å·¦ä¸Šè§’
                                ctx.fillText(txt, drawX, drawY);
                            }
                        }

                        gif.addFrame(ctx, {copy: true, delay: 1000/fps});
                        loadingTitle.innerText = "æ­£åœ¨æ•è·...";
                        pText.innerText = `è¿›åº¦: ${cur.toFixed(1)}s / ${end}s`;
                        resolve();
                    };
                    video.addEventListener('seeked', onSeeked);
                });

                while(cur < end) { await capture(); cur += step; }

                loadingTitle.innerText = "ç”Ÿæˆæ–‡ä»¶...";
                gif.on('finished', blob => {
                    overlay.classList.add('hidden'); overlay.classList.remove('flex');
                    btn.disabled = false; video.volume = oldVol;
                    const url = URL.createObjectURL(blob);
                    document.getElementById('result-gif').src = url;
                    document.getElementById('download-link').href = url;
                    document.getElementById('file-size').innerText = (blob.size/1024/1024).toFixed(2) + " MB";
                    document.getElementById('result-modal').classList.remove('hidden');
                });
                
                gif.render();

            } catch(e) {
                console.error(e);
                alert("å‘ç”Ÿé”™è¯¯: " + e.message);
                overlay.classList.add('hidden'); overlay.classList.remove('flex');
                btn.disabled = false;
            }
        });

        updateStageStyle();
    </script>
</body>
</html>